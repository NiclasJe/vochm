<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/.github/workflows/docker-image.yml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.github/workflows/docker-image.yml" />
              <option name="originalContent" value="permissions:&#10;  contents: read&#10;  packages: write&#10;&#10;name: Build and Deploy&#10;&#10;on:&#10;  push:&#10;    branches:&#10;      - main&#10;&#10;jobs:&#10;&#10;  integration_test_android:&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;&#10;      - uses: subosito/flutter-action@v2&#10;        with:&#10;          flutter-version: '3.24.0'&#10;          channel: 'stable'&#10;&#10;      - name: Set up Docker Buildx&#10;        uses: docker/setup-buildx-action@v2&#10;&#10;      - name: Create .env for docker-compose&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          cat &gt; .env &lt;&lt;EOF&#10;          POSTGRES_USER=postgres&#10;          POSTGRES_PASSWORD=1122&#10;          POSTGRES_DB=vochm&#10;          EOF&#10;          echo &quot;.env file created for docker-compose&quot;&#10;          echo &quot;=== .env contents ===&quot;&#10;          cat .env&#10;&#10;      - name: Create Serverpod passwords.yaml&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          mkdir -p config&#10;          cat &gt; config/passwords.yaml &lt;&lt;EOF&#10;          production:&#10;            database: '1122'&#10;          development:&#10;            database: '1122'&#10;          staging:&#10;            database: '1122'&#10;          EOF&#10;          echo &quot;Serverpod passwords.yaml created&quot;&#10;          echo &quot;=== config directory contents ===&quot;&#10;          ls -la config/&#10;&#10;      - name: Start database and server with docker-compose&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          echo &quot;Starting services with docker-compose...&quot;&#10;          docker compose up -d --build&#10;&#10;          echo &quot;Waiting for services to be healthy...&quot;&#10;          # Wait for postgres to be healthy with proper timeout&#10;          postgres_ready=0&#10;          for i in $(seq 1 60); do&#10;            if docker compose exec -T postgres pg_isready -U postgres &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Postgres is ready&quot;&#10;              postgres_ready=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for Postgres... ($i/60)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$postgres_ready&quot; != &quot;1&quot; ]]; then&#10;            echo &quot;ERROR: Postgres did not become ready in time&quot;&#10;            docker compose logs postgres&#10;            exit 1&#10;          fi&#10;&#10;          # Wait for server to be ready (check if it's responding)&#10;          echo &quot;Waiting for server to start...&quot;&#10;          server_ready=0&#10;          for i in $(seq 1 60); do&#10;            if curl -f http://localhost:8080/ &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Server is responding&quot;&#10;              server_ready=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for server to respond... ($i/60)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$server_ready&quot; != &quot;1&quot; ]]; then&#10;            echo &quot;WARNING: Server may not be fully ready, but continuing...&quot;&#10;          fi&#10;&#10;          echo &quot;=== Docker Compose Services Status ===&quot;&#10;          docker compose ps&#10;&#10;          echo &quot;=== Server Logs ===&quot;&#10;          docker compose logs server&#10;&#10;          echo &quot;=== Postgres Logs ===&quot;&#10;          docker compose logs postgres&#10;&#10;      - name: Verify server is responding&#10;        shell: bash&#10;        run: |&#10;          set -euo pipefail&#10;          echo &quot;Testing server connectivity...&quot;&#10;          server_responding=0&#10;          for i in $(seq 1 30); do&#10;            if curl -f http://localhost:8080/ &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Server is responding on port 8080&quot;&#10;              server_responding=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for server to respond... ($i/30)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$server_responding&quot; == &quot;1&quot; ]]; then&#10;            # Test endpoint connectivity&#10;            curl -v http://localhost:8080/ || echo &quot;Server check failed but continuing...&quot;&#10;          else&#10;            echo &quot;WARNING: Server not responding after timeout, checking logs...&quot;&#10;            cd vochm/vochm_server &amp;&amp; docker compose logs server&#10;          fi&#10;      &#10;&#10;      - name: Setup Dart&#10;        uses: dart-lang/setup-dart@v1&#10;&#10;      - name: Install server dependencies&#10;        working-directory: ./vochm/vochm_server&#10;        run: dart pub get&#10;&#10;      - name: Activate Serverpod CLI&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          # Activate the Serverpod CLI package&#10;          dart pub global activate serverpod_cli&#10;          # Expose global binaries in PATH for subsequent steps&#10;          echo &quot;$HOME/.pub-cache/bin&quot; &gt;&gt; $GITHUB_PATH&#10;          # Verify the CLI is available&#10;          serverpod --version || (echo &quot;serverpod CLI not found on PATH&quot; &amp;&amp; exit 1)&#10;&#10;      - name: Wait for Postgres&#10;        run: |&#10;          for i in {1..60}; do&#10;            pg_isready -h localhost -p 5432 -U postgres &amp;&amp; break&#10;            sleep 2&#10;          done&#10;&#10;      - name: Start Serverpod server&#10;        working-directory: ./vochm/vochm_server&#10;        env:&#10;          DATABASE_HOST: localhost&#10;          DATABASE_PORT: 5432&#10;          DATABASE_NAME: vochm_test&#10;          DATABASE_USER: postgres&#10;          DATABASE_PASSWORD: postgres&#10;        run: |&#10;          echo &quot;Starting serverpod...&quot;&#10;          # Ensure env variables are exported for the background process&#10;          export DATABASE_HOST=&quot;${DATABASE_HOST}&quot;&#10;          export DATABASE_PORT=&quot;${DATABASE_PORT}&quot;&#10;          export DATABASE_NAME=&quot;${DATABASE_NAME}&quot;&#10;          export DATABASE_USER=&quot;${DATABASE_USER}&quot;&#10;          export DATABASE_PASSWORD=&quot;${DATABASE_PASSWORD}&quot;&#10;&#10;          # Start server via serverpod CLI so flags like --apply-migrations and --address are recognized&#10;          nohup serverpod run --apply-migrations --address 0.0.0.0 &gt; server.log 2&gt;&amp;1 &amp;&#10;          # Give server time to boot and apply migrations&#10;          sleep 30&#10;          tail -n +1 server.log&#10;&#10;      # Prepare Flutter app&#10;      - name: Install Flutter dependencies&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter pub get&#10;&#10;      # Run integration tests on Android&#10;      - name: Setup Android SDK&#10;        uses: android-actions/setup-android@v2&#10;&#10;      - name: Create AVD and run tests&#10;        uses: reactivecircus/android-emulator-runner@v2&#10;        with:&#10;          api-level: 33&#10;          arch: x86_64&#10;          profile: pixel_6&#10;          force-avd-creation: true&#10;          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim -wipe-data -no-snapshot&#10;          emulator-boot-timeout: 1800&#10;          script: ./ci/run_emulator_tests.sh&#10;&#10;      - name: Upload integration test artifacts&#10;        if: always()&#10;        uses: actions/upload-artifact@v4&#10;        with:&#10;          name: integration-test-diagnostics&#10;          path: |&#10;            ci-*.txt&#10;            vochm/vochm_flutter/integration_test/*.log&#10;          if-no-files-found: ignore&#10;          retention-days: 7&#10;&#10;      - name: Collect docker-compose logs&#10;        if: always()&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          echo &quot;Collecting final logs...&quot;&#10;          docker compose logs server &gt; ../../server-final.log 2&gt;&amp;1 || true&#10;          docker compose logs postgres &gt; ../../postgres-final.log 2&gt;&amp;1 || true&#10;&#10;      - name: Upload docker-compose logs&#10;        if: always()&#10;        uses: actions/upload-artifact@v4&#10;        with:&#10;          name: docker-compose-logs&#10;          path: |&#10;            server-final.log&#10;            postgres-final.log&#10;          if-no-files-found: ignore&#10;          retention-days: 7&#10;&#10;      - name: Cleanup docker-compose services&#10;        if: always()&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          echo &quot;Stopping docker-compose services...&quot;&#10;          docker compose down -v&#10;  test:&#10;    name: Run Flutter Unit Tests&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - name: Checkout code&#10;        uses: actions/checkout@v3&#10;&#10;      - name: Install Flutter&#10;        uses: subosito/flutter-action@v2&#10;        with:&#10;          channel: stable&#10;          cache: true&#10;&#10;      - name: Load Flutter dependencies&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter pub get&#10;&#10;      - name: Run tests&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter test --no-pub&#10;&#10;  build:&#10;    name: Build Docker Image&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - name: Checkout code&#10;        uses: actions/checkout@v3&#10;&#10;      - name: Set up Docker Buildx&#10;        uses: docker/setup-buildx-action@v2&#10;&#10;      - name: Log in to GitHub Container Registry&#10;        uses: docker/login-action@v2&#10;        with:&#10;          registry: ghcr.io&#10;          username: ${{ github.actor }}&#10;          password: ${{ secrets.CR_PAT || secrets.GITHUB_TOKEN }}&#10;&#10;      - name: Build and push Docker image&#10;        uses: docker/build-push-action@v4&#10;        with:&#10;          context: ./vochm/vochm_server&#10;          file: ./vochm/vochm_server/Dockerfile&#10;          push: true&#10;          tags: |&#10;            ghcr.io/niclasje/vochm:latest&#10;            ghcr.io/niclasje/vochm:${{ github.sha }}&#10;&#10;  deploy:&#10;    name: Deploy to VM&#10;    runs-on: ubuntu-latest&#10;    needs: [test, build]&#10;&#10;    steps:&#10;      - name: SSH deploy&#10;        uses: appleboy/ssh-action@v0.1.7&#10;        with:&#10;          host: ${{ secrets.VM_HOST }}&#10;          username: ${{ secrets.VM_USER }}&#10;          key: ${{ secrets.VM_SSH_KEY }}&#10;          script: |&#10;            cd /path/to/your/docker-compose/folder&#10;            docker pull ghcr.io/${{ github.repository_owner }}/vochm:latest&#10;            docker compose down&#10;            docker compose up -d --build&#10;" />
              <option name="updatedContent" value="permissions:&#10;  contents: read&#10;  packages: write&#10;&#10;name: Build and Deploy&#10;&#10;on:&#10;  push:&#10;    branches:&#10;      - main&#10;&#10;jobs:&#10;&#10;  integration_test_android:&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;&#10;      - uses: subosito/flutter-action@v2&#10;        with:&#10;          flutter-version: '3.24.0'&#10;          channel: 'stable'&#10;&#10;      - name: Set up Docker Buildx&#10;        uses: docker/setup-buildx-action@v2&#10;&#10;      - name: Create .env for docker-compose&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          cat &gt; .env &lt;&lt;EOF&#10;          POSTGRES_USER=postgres&#10;          POSTGRES_PASSWORD=1122&#10;          POSTGRES_DB=vochm&#10;          EOF&#10;          echo &quot;.env file created for docker-compose&quot;&#10;          echo &quot;=== .env contents ===&quot;&#10;          cat .env&#10;&#10;      - name: Create Serverpod passwords.yaml&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          mkdir -p config&#10;          cat &gt; config/passwords.yaml &lt;&lt;EOF&#10;          production:&#10;            database: '1122'&#10;          development:&#10;            database: '1122'&#10;          staging:&#10;            database: '1122'&#10;          EOF&#10;          echo &quot;Serverpod passwords.yaml created&quot;&#10;          echo &quot;=== config directory contents ===&quot;&#10;          ls -la config/&#10;&#10;      - name: Start database and server with docker-compose&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          set -euo pipefail&#10;          echo &quot;Starting services with docker-compose...&quot;&#10;          docker compose up -d --build&#10;&#10;          echo &quot;Waiting for services to be healthy...&quot;&#10;          # Wait for postgres to be healthy with proper timeout&#10;          postgres_ready=0&#10;          for i in $(seq 1 60); do&#10;            if docker compose exec -T postgres pg_isready -U postgres &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Postgres is ready&quot;&#10;              postgres_ready=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for Postgres... ($i/60)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$postgres_ready&quot; != &quot;1&quot; ]]; then&#10;            echo &quot;ERROR: Postgres did not become ready in time&quot;&#10;            docker compose logs postgres&#10;            exit 1&#10;          fi&#10;&#10;          # Wait for server to be ready (check if it's responding)&#10;          echo &quot;Waiting for server to start...&quot;&#10;          server_ready=0&#10;          for i in $(seq 1 60); do&#10;            if curl -f http://localhost:8080/ &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Server is responding&quot;&#10;              server_ready=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for server to respond... ($i/60)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$server_ready&quot; != &quot;1&quot; ]]; then&#10;            echo &quot;WARNING: Server may not be fully ready, but continuing...&quot;&#10;          fi&#10;&#10;          echo &quot;=== Docker Compose Services Status ===&quot;&#10;          docker compose ps&#10;&#10;          echo &quot;=== Server Logs ===&quot;&#10;          docker compose logs server&#10;&#10;          echo &quot;=== Postgres Logs ===&quot;&#10;          docker compose logs postgres&#10;&#10;      - name: Verify server is responding&#10;        shell: bash&#10;        run: |&#10;          set -euo pipefail&#10;          echo &quot;Testing server connectivity...&quot;&#10;          server_responding=0&#10;          for i in $(seq 1 30); do&#10;            if curl -f http://localhost:8080/ &gt; /dev/null 2&gt;&amp;1; then&#10;              echo &quot;Server is responding on port 8080&quot;&#10;              server_responding=1&#10;              break&#10;            fi&#10;            echo &quot;Waiting for server to respond... ($i/30)&quot;&#10;            sleep 2&#10;          done&#10;&#10;          if [[ &quot;$server_responding&quot; == &quot;1&quot; ]]; then&#10;            # Test endpoint connectivity&#10;            curl -v http://localhost:8080/ || echo &quot;Server check failed but continuing...&quot;&#10;          else&#10;            echo &quot;WARNING: Server not responding after timeout, checking logs...&quot;&#10;            cd vochm/vochm_server &amp;&amp; docker compose logs server&#10;          fi&#10;      &#10;&#10;      - name: Setup Dart&#10;        uses: dart-lang/setup-dart@v1&#10;&#10;      - name: Install server dependencies&#10;        working-directory: ./vochm/vochm_server&#10;        run: dart pub get&#10;&#10;      - name: Activate Serverpod CLI&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          # Activate the Serverpod CLI package&#10;          dart pub global activate serverpod_cli&#10;          # Expose global binaries in PATH for subsequent steps&#10;          echo &quot;$HOME/.pub-cache/bin&quot; &gt;&gt; $GITHUB_PATH&#10;          # Verify the CLI is available&#10;          serverpod --version || (echo &quot;serverpod CLI not found on PATH&quot; &amp;&amp; exit 1)&#10;&#10;      - name: Wait for Postgres&#10;        run: |&#10;          for i in {1..60}; do&#10;            pg_isready -h localhost -p 5432 -U postgres &amp;&amp; break&#10;            sleep 2&#10;          done&#10;&#10;      - name: Start Serverpod server&#10;        working-directory: ./vochm/vochm_server&#10;        env:&#10;          DATABASE_HOST: localhost&#10;          DATABASE_PORT: 5432&#10;          DATABASE_NAME: vochm_test&#10;          DATABASE_USER: postgres&#10;          DATABASE_PASSWORD: postgres&#10;        run: |&#10;          echo &quot;Starting serverpod...&quot;&#10;          # Ensure env variables are exported for the background process&#10;          export DATABASE_HOST=&quot;${DATABASE_HOST}&quot;&#10;          export DATABASE_PORT=&quot;${DATABASE_PORT}&quot;&#10;          export DATABASE_NAME=&quot;${DATABASE_NAME}&quot;&#10;          export DATABASE_USER=&quot;${DATABASE_USER}&quot;&#10;          export DATABASE_PASSWORD=&quot;${DATABASE_PASSWORD}&quot;&#10;&#10;          # Start server via serverpod CLI so flags like --apply-migrations and --address are recognized&#10;          nohup serverpod run --apply-migrations --address 0.0.0.0 &gt; server.log 2&gt;&amp;1 &amp;&#10;          # Give server time to boot and apply migrations&#10;          sleep 30&#10;          tail -n +1 server.log&#10;&#10;      # Prepare Flutter app&#10;      - name: Install Flutter dependencies&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter pub get&#10;&#10;      # Run integration tests on Android&#10;      - name: Setup Android SDK&#10;        uses: android-actions/setup-android@v2&#10;&#10;      - name: Create AVD and run tests&#10;        uses: reactivecircus/android-emulator-runner@v2&#10;        with:&#10;          api-level: 33&#10;          arch: x86_64&#10;          profile: pixel_6&#10;          force-avd-creation: true&#10;          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim -wipe-data -no-snapshot&#10;          emulator-boot-timeout: 1800&#10;          script: ./ci/run_emulator_tests.sh&#10;&#10;      - name: Upload integration test artifacts&#10;        if: always()&#10;        uses: actions/upload-artifact@v4&#10;        with:&#10;          name: integration-test-diagnostics&#10;          path: |&#10;            ci-*.txt&#10;            ci-emulator-logcat.txt&#10;            ci-dumpsys-activity.txt&#10;            ci-ps.txt&#10;            ci-adb-forward-list.txt&#10;            vochm/vochm_flutter/integration_test/*.log&#10;          if-no-files-found: ignore&#10;          retention-days: 7&#10;&#10;      - name: Collect docker-compose logs&#10;        if: always()&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          echo &quot;Collecting final logs...&quot;&#10;          docker compose logs server &gt; ../../server-final.log 2&gt;&amp;1 || true&#10;          docker compose logs postgres &gt; ../../postgres-final.log 2&gt;&amp;1 || true&#10;&#10;      - name: Upload docker-compose logs&#10;        if: always()&#10;        uses: actions/upload-artifact@v4&#10;        with:&#10;          name: docker-compose-logs&#10;          path: |&#10;            server-final.log&#10;            postgres-final.log&#10;          if-no-files-found: ignore&#10;          retention-days: 7&#10;&#10;      - name: Cleanup docker-compose services&#10;        if: always()&#10;        shell: bash&#10;        working-directory: ./vochm/vochm_server&#10;        run: |&#10;          echo &quot;Stopping docker-compose services...&quot;&#10;          docker compose down -v&#10;  test:&#10;    name: Run Flutter Unit Tests&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - name: Checkout code&#10;        uses: actions/checkout@v3&#10;&#10;      - name: Install Flutter&#10;        uses: subosito/flutter-action@v2&#10;        with:&#10;          channel: stable&#10;          cache: true&#10;&#10;      - name: Load Flutter dependencies&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter pub get&#10;&#10;      - name: Run tests&#10;        working-directory: ./vochm/vochm_flutter&#10;        run: flutter test --no-pub&#10;&#10;  build:&#10;    name: Build Docker Image&#10;    runs-on: ubuntu-latest&#10;&#10;    steps:&#10;      - name: Checkout code&#10;        uses: actions/checkout@v3&#10;&#10;      - name: Set up Docker Buildx&#10;        uses: docker/setup-buildx-action@v2&#10;&#10;      - name: Log in to GitHub Container Registry&#10;        uses: docker/login-action@v2&#10;        with:&#10;          registry: ghcr.io&#10;          username: ${{ github.actor }}&#10;          password: ${{ secrets.CR_PAT || secrets.GITHUB_TOKEN }}&#10;&#10;      - name: Build and push Docker image&#10;        uses: docker/build-push-action@v4&#10;        with:&#10;          context: ./vochm/vochm_server&#10;          file: ./vochm/vochm_server/Dockerfile&#10;          push: true&#10;          tags: |&#10;            ghcr.io/niclasje/vochm:latest&#10;            ghcr.io/niclasje/vochm:${{ github.sha }}&#10;&#10;  deploy:&#10;    name: Deploy to VM&#10;    runs-on: ubuntu-latest&#10;    needs: [test, build]&#10;&#10;    steps:&#10;      - name: SSH deploy&#10;        uses: appleboy/ssh-action@v0.1.7&#10;        with:&#10;          host: ${{ secrets.VM_HOST }}&#10;          username: ${{ secrets.VM_USER }}&#10;          key: ${{ secrets.VM_SSH_KEY }}&#10;          script: |&#10;            cd /path/to/your/docker-compose/folder&#10;            docker pull ghcr.io/${{ github.repository_owner }}/vochm:latest&#10;            docker compose down&#10;            docker compose up -d --build&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>